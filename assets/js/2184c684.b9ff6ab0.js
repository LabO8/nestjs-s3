"use strict";(globalThis.webpackChunksite=globalThis.webpackChunksite||[]).push([[7115],{5096(e,r,t){t.r(r),t.d(r,{assets:()=>o,contentTitle:()=>s,default:()=>c,frontMatter:()=>l,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"multipart-upload","title":"Multipart Upload","description":"The Multipart Upload Service provides functionality for uploading large files to S3 using the multipart upload API. This approach is recommended for files larger than 100MB and allows you to:","source":"@site/docs/multipart-upload.md","sourceDirName":".","slug":"/multipart-upload","permalink":"/nestjs-s3/multipart-upload","draft":false,"unlisted":false,"editUrl":"https://github.com/LabO8/nestjs-s3/docs/multipart-upload.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Objects","permalink":"/nestjs-s3/objects-service"},"next":{"title":"Signed URL service","permalink":"/nestjs-s3/signed-url-service"}}');var i=t(4848),a=t(8453);const l={},s="Multipart Upload",o={},d=[{value:"Overview",id:"overview",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Usage",id:"usage",level:2},{value:"Basic Workflow",id:"basic-workflow",level:2},{value:"API Reference",id:"api-reference",level:2},{value:"initiateMultipartUpload",id:"initiatemultipartupload",level:3},{value:"getUploadPartPresignedUrl",id:"getuploadpartpresignedurl",level:3},{value:"completeMultipartUpload",id:"completemultipartupload",level:3},{value:"abortMultipartUpload",id:"abortmultipartupload",level:3},{value:"listParts",id:"listparts",level:3},{value:"calculatePartSize",id:"calculatepartsize",level:3},{value:"Important Notes",id:"important-notes",level:2},{value:"Prefix Configuration",id:"prefix-configuration",level:2},{value:"Error Handling",id:"error-handling",level:2}];function p(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"multipart-upload",children:"Multipart Upload"})}),"\n",(0,i.jsx)(r.p,{children:"The Multipart Upload Service provides functionality for uploading large files to S3 using the multipart upload API. This approach is recommended for files larger than 100MB and allows you to:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Upload large files in smaller, manageable parts"}),"\n",(0,i.jsx)(r.li,{children:"Resume failed uploads"}),"\n",(0,i.jsx)(r.li,{children:"Upload parts in parallel for better performance"}),"\n",(0,i.jsx)(r.li,{children:"Upload files while they're being created"}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(r.p,{children:"A multipart upload involves three main steps:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Initiate"})," - Start a new multipart upload and get an upload ID"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Upload Parts"})," - Upload file chunks using presigned URLs"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Complete"})," - Finalize the upload by providing the list of uploaded parts"]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["Alternatively, you can ",(0,i.jsx)(r.strong,{children:"abort"})," an upload if something goes wrong."]}),"\n",(0,i.jsx)(r.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(r.p,{children:"You can configure the default part size for multipart uploads globally when setting up the S3Module:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"S3Module.forRoot({\n  region: 'us-east-1',\n  accessKeyId: 'your-access-key',\n  secretAccessKey: 'your-secret-key',\n  multipartUpload: {\n    defaultPartSize: 10 * 1024 * 1024, // 10MB (default is 5MB)\n  },\n});\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Configuration Options:"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"defaultPartSize"})," - Default part size in bytes (must be at least 5MB)","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Default: ",(0,i.jsx)(r.code,{children:"5242880"})," (5MB - AWS minimum)"]}),"\n",(0,i.jsx)(r.li,{children:"Recommendation: Use 10MB or higher for better performance with large files"}),"\n",(0,i.jsxs)(r.li,{children:["This is used when ",(0,i.jsx)(r.code,{children:"calculatePartSize()"})," is called without a preferred size"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"usage",children:"Usage"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"import { MultipartUploadService } from '@lab08/nestjs-s3';\n\n@Injectable()\nexport class UploadService {\n  constructor(\n    private readonly multipartUploadService: MultipartUploadService,\n  ) {}\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"basic-workflow",children:"Basic Workflow"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"// Step 1: Initiate upload\nconst { uploadId, key } = await multipartUploadService.initiateMultipartUpload(\n  'my-bucket',\n  'large-file.zip',\n  { ContentType: 'application/zip' }\n);\n\n// Step 2: Calculate part size\nconst { partSize, totalParts } = multipartUploadService.calculatePartSize(fileSize);\n\n// Step 3: Upload each part using presigned URLs\nconst parts = [];\nfor (let partNumber = 1; partNumber <= totalParts; partNumber++) {\n  const { url } = await multipartUploadService.getUploadPartPresignedUrl(\n    'my-bucket',\n    key,\n    uploadId,\n    partNumber\n  );\n  \n  // Upload part data to presigned URL\n  const response = await axios.put(url, partData);\n  parts.push({ ETag: response.headers.etag, PartNumber: partNumber });\n}\n\n// Step 4: Complete upload\nawait multipartUploadService.completeMultipartUpload(\n  'my-bucket',\n  key,\n  uploadId,\n  parts\n);\n"})}),"\n",(0,i.jsx)(r.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,i.jsx)(r.h3,{id:"initiatemultipartupload",children:"initiateMultipartUpload"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"async initiateMultipartUpload(\n  bucket: string,\n  key: string,\n  options?: MultipartUploadOptions,\n): Promise<MultipartUploadInitiation>\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Initiates a multipart upload. Returns ",(0,i.jsx)(r.code,{children:"uploadId"})," and prefixed ",(0,i.jsx)(r.code,{children:"key"})," to use in subsequent operations."]}),"\n",(0,i.jsx)(r.h3,{id:"getuploadpartpresignedurl",children:"getUploadPartPresignedUrl"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"async getUploadPartPresignedUrl(\n  bucket: string,\n  key: string,\n  uploadId: string,\n  partNumber: number,\n  expiresIn?: number,\n): Promise<PresignedUploadUrl>\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Generates presigned URL for uploading a part (1-10000). Use the ",(0,i.jsx)(r.code,{children:"key"})," from initiate response."]}),"\n",(0,i.jsx)(r.h3,{id:"completemultipartupload",children:"completeMultipartUpload"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"async completeMultipartUpload(\n  bucket: string,\n  key: string,\n  uploadId: string,\n  parts: UploadPart[],\n): Promise<MultipartUploadCompletion>\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Completes upload. ",(0,i.jsx)(r.code,{children:"parts"})," must be sorted by ",(0,i.jsx)(r.code,{children:"PartNumber"})," with ",(0,i.jsx)(r.code,{children:"ETag"})," from upload responses."]}),"\n",(0,i.jsx)(r.h3,{id:"abortmultipartupload",children:"abortMultipartUpload"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"async abortMultipartUpload(\n  bucket: string,\n  key: string,\n  uploadId: string,\n): Promise<MultipartUploadAbortion>\n"})}),"\n",(0,i.jsx)(r.p,{children:"Aborts upload and removes uploaded parts."}),"\n",(0,i.jsx)(r.h3,{id:"listparts",children:"listParts"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"async listParts(\n  bucket: string,\n  key: string,\n  uploadId: string,\n  maxParts?: number,\n  partNumberMarker?: number,\n): Promise<ListPartsResult>\n"})}),"\n",(0,i.jsx)(r.p,{children:"Lists uploaded parts for an upload."}),"\n",(0,i.jsx)(r.h3,{id:"calculatepartsize",children:"calculatePartSize"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"calculatePartSize(\n  fileSize: number,\n  preferredPartSize?: number\n): PartSizeCalculation\n"})}),"\n",(0,i.jsx)(r.p,{children:"Calculates optimal part size and total number of parts for a file."}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Parameters:"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"fileSize"})," - Total file size in bytes (must be > 0)"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"preferredPartSize"})," - Optional preferred part size in bytes ( ",(0,i.jsx)(r.code,{children:">= 5MB"})," if provided)"]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Returns:"})," ",(0,i.jsx)(r.code,{children:"{ partSize: number, totalParts: number }"})]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Priority order for part size:"})}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"preferredPartSize"})," parameter (highest priority)"]}),"\n",(0,i.jsxs)(r.li,{children:["Module configuration ",(0,i.jsx)(r.code,{children:"defaultPartSize"})]}),"\n",(0,i.jsx)(r.li,{children:"AWS minimum 5MB (fallback)"}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"The function automatically increases part size if needed to stay within AWS's 10,000 part limit."}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Examples:"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"// Use configured default (or AWS minimum if not configured)\nconst result1 = multipartUploadService.calculatePartSize(100 * 1024 * 1024);\n// Uses module config or 5MB\n\n// Override with custom part size for this specific calculation\nconst result2 = multipartUploadService.calculatePartSize(\n  100 * 1024 * 1024,\n  50 * 1024 * 1024 // Use 50MB parts\n);\n\n// Auto-adjusts for very large files\nconst result3 = multipartUploadService.calculatePartSize(100 * 1024 * 1024 * 1024);\n// Automatically increases part size to stay within 10,000 parts limit\n"})}),"\n",(0,i.jsx)(r.h2,{id:"important-notes",children:"Important Notes"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Store the key"}),": Use the ",(0,i.jsx)(r.code,{children:"key"})," returned from ",(0,i.jsx)(r.code,{children:"initiateMultipartUpload"})," for all subsequent operations (it includes prefixes)"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Sort parts"}),": Parts must be sorted by ",(0,i.jsx)(r.code,{children:"PartNumber"})," when completing upload"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Always abort on failure"}),": Prevent orphaned parts by aborting failed uploads"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Part constraints"}),": Min 5MB (except last), max 10,000 parts, part numbers 1-10000"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Transfer Acceleration"}),": Combine multipart uploads with S3 Transfer Acceleration to reduce latency by routing data through AWS edge locations. You need to enable the accelerated endpoint for your bucket in the AWS S3 console, and then configure the S3Module as follows:"]}),"\n"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"S3Module.forRoot({\n// ...other config...\n  useAccelerateEndpoint: true, // Enable Transfer Acceleration\n});\n"})}),"\n",(0,i.jsx)(r.h2,{id:"prefix-configuration",children:"Prefix Configuration"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"// Uses global prefix\nconst result = await multipartUploadService.initiateMultipartUpload('bucket', 'file.zip');\n// result.key = 'prefix/file.zip'\n\n// Disable auto-prefix\nconst result = await multipartUploadService.initiateMultipartUpload(\n  'bucket',\n  'file.zip',\n  { disableAutoPrefix: true }\n);\n// result.key = 'file.zip'\n"})}),"\n",(0,i.jsx)(r.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-typescript",children:"try {\n  const { uploadId, key } = await multipartUploadService.initiateMultipartUpload(...);\n  // ... upload parts ...\n  await multipartUploadService.completeMultipartUpload(bucket, key, uploadId, parts);\n} catch (error) {\n  await multipartUploadService.abortMultipartUpload(bucket, key, uploadId);\n  throw error;\n}\n"})})]})}function c(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},8453(e,r,t){t.d(r,{R:()=>l,x:()=>s});var n=t(6540);const i={},a=n.createContext(i);function l(e){const r=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function s(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),n.createElement(a.Provider,{value:r},e.children)}}}]);